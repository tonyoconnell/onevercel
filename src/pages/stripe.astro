---
import { Stripe as StripeClient } from "stripe";

let session;
let error: string | null = null;

try {
  const stripeKey = import.meta.env.STRIPE_SECRET_KEY;
  if (!stripeKey) {
    throw new Error('Stripe secret key is not configured');
  }

  const stripe = new StripeClient(stripeKey, {
    apiVersion: '2025-01-27.acacia' // Add explicit API version
  });
  
  const { origin } = Astro.url;
  console.log('Creating Stripe session with origin:', origin); // Debug log
  
  session = await stripe.checkout.sessions.create({
    mode: "subscription",
    line_items: [
      {
        price: "price_0MC5WIqs14Mpveu1bfwvrkq6",
        quantity: 1,
      },
    ],
    success_url: `${origin}/thankyou?session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${origin}/stripe`,
  });

  if (session.url) {
    return Astro.redirect(session.url);
  }
} catch (e) {
  console.error('Stripe error details:', {
    error: e,
    message: e instanceof Error ? e.message : 'Unknown error',
    env: !!import.meta.env.STRIPE_SECRET_KEY ? 'Key exists' : 'Key missing'
  });
  error = e instanceof Error ? e.message : 'An error occurred with the payment system';
}
---
Update price to match the subscription plan you created in your Stripe Dashboard. The `success_url` and `cancel_url` are set to `/thankyou` and `/stripe` respectively. You can update these URLs to match your site's structure.